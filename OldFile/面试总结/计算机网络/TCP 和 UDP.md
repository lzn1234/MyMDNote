#### TCP和UDP的区别以应用场景

TCP和UDP都是传输层的协议

TCP提供的是面向连接的、可靠的数据传输服务，提供<u>拥塞控制</u>和<u>流量控制</u>机制来保证数据传输的安全性和可靠性，且只能进行**点到点**的通信。适用场景：文件传输、邮件发送接收、远程登录。

UDP提供的是不需要连接的数据传输服务，尽最大努力交付数据，不能保证数据传输的可靠性，可以进行一对一，一对多，多对多的一个通性。适用场景：直播、视频连接、语音通话。



##### TCP报文首部

<img src="/Users/zhennan/Public/Typora Project/面试总结/计算机网络/68747470733a2f2f63732d6e6f7465732d313235363130393739362e636f732e61702d6775616e677a686f752e6d7971636c6f75642e636f6d2f35356463346538342d353733642d346331332d613736352d3532656431646432353166392e706e67.png" alt="img" style="zoom: 33%;" />

- **序号** ：用于对字节流进行编号，例如序号为 301，表示第一个字节的编号为 301，如果携带的数据长度为 100 字节，那么下一个报文段的序号应为 401。
- **确认号** ：期望收到的下一个报文段的序号。例如 B 正确收到 A 发送来的一个报文段，序号为 501，携带的数据长度为 200 字节，因此 B 期望下一个报文段的序号为 701，B 发送给 A 的确认报文段中确认号就为 701。
- **数据偏移** ：指的是数据部分距离报文段起始处的偏移量，实际上指的是首部的长度。
- **确认 ACK** ：当 ACK=1 时确认号字段有效，否则无效。TCP 规定，在连接建立后所有传送的报文段都必须把 ACK 置 1。
- **同步 SYN** ：在连接建立时用来同步序号。当 SYN=1，ACK=0 时表示这是一个连接请求报文段。若对方同意建立连接，则响应报文中 SYN=1，ACK=1。
- **终止 FIN** ：用来释放一个连接，当 FIN=1 时，表示此报文段的发送方的数据已发送完毕，并要求释放连接。
- **窗口** ：窗口值作为接收方让发送方设置其发送窗口的依据。之所以要有这个限制，是因为接收方的数据缓存空间是有限的



##### UDP报文首部



#### TCP的三次握手和四次挥手问题

SYN（同步报文段）、ACK（确认报文段）、FIN（终止报文段）

##### 三次握手过程

目的：确认对方和自己的发送能力、接收能力都没有问题

客户端向服务端发起请求连接，需要向服务 端发送一个**SYN报文**——**一次握手**

服务端接收到客户端的SYN报文，返回给客户端**SYN、ACK报文**，<u>确认对方的发送能力和自己的接收能力正常</u>。——**二次握手**

客户端接收该报文，<u>确认双方的发送能力和接收能力正常</u>，随后向服务端发送**ACK报文**，服务端接收到客服端发送的ACK报文，<u>确认客户端的接收能力和自己的发送能力正常</u>。到这个阶段时，双方都能确定两方的收发能力正常，正式通过TCP建立了连接。——**三次握手**

<img src="https://mmbiz.qpic.cn/mmbiz_png/n0eUfo2l3X4GW4RzuChrFX1c5y0p4tAicbW9SszupLVgtkvUJ9jic5r0DwxdzrzU3CWd3BcFjGqUagprmqy2ct9g/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片" style="zoom:70%;" />





##### 四次挥手过程

目的：关闭一个TCP连接

客服端向服务端发起断开连接请求，向服务端发送**FIN报文**——**一次挥手**

服务端返回客户端**ACK报文**。此时服务端进入关闭等待阶段，而不是马上给客户端发送FIN报文，因为服务端可以有未发完的数据。**此时客户端到服务端的连接已经断开，但TCP连接是全双工的，可能服务端还有未发完的数据，所以此时TCP连接的半断开的**——**二次挥手** 

服务端数据发送完毕，向客户端发送**ACK，FIN报文**——**三次挥手** 

客户端回应一个**ACK报文**。此时客户端不会马上断开TCP连接，而是会等待2msl（msl为最长报文段寿命）之后释放TCP连接。服务端如果接收到ACK报文会马上释放TCP连接。所以一般来说服务端TCP的释放时间会比客户端早。到此，**两端均释放TCP连接，TCP连接关闭。**——**三次挥手**



<img src="https://mmbiz.qpic.cn/mmbiz_png/n0eUfo2l3X4GW4RzuChrFX1c5y0p4tAicDhcmN0vJdTxFrqJoA31yxIZ2jY5jLJic4eNlRelhlSHDtPndBRZRhWQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1" alt="图片" style="zoom:70%;" />



##### 为什么两次握手不行，需要三次握手

TCP是一个全双工的协议，他需要保证双方的收发能力正常。

如果只进行二次握手的话，**服务端无法确认自己的发送能力和对方的接收能力是否正常。**当**服务端返回的SYN、ACK报文出现丢包**的情况，这时候服务端已经做好的收发的准备（服务端连接成功），而客户端因为没有收到服务端的确认报文，不知道服务端是否准备好了（客户端未连接成功），使得客户端不会向服务端发送数据，也不会接收来自服务端的数据。

如果进行三次握手的话，两端都可以确定自己和对方具有收发的能力。如果出现丢包的问题，服务端会因为**没有收到三次握手的确认报文**而重新进行二次握手。

第三次握手和第四次挥手是为了防止出现：因为上一步操作出现丢包的情况而导致**一端已经准备好连接/断开**，而另一段**因为没收到回应无法进行下一步的操作**



##### 为什么TCP连接的时候要进行三次握手，断开的时候却要进行四次挥手

因为申请连接可以马上回应ACK和SYN报文，而断开连接不能直接回应FIN和ACK报文

相比于连接操作，断开连接需要考虑的情况比较多，需要考虑服务端是否还有未发完的数据。所以服务端只能先回应ACK报文表示自己已经收到了请求，等到数据传输完了之后在给客户端发送ACK、FIN报文表示可以断开连接了。



##### 为什么客户端第四次挥手发送完毕还要等待2msl才断开TCP连接

还是要考虑发生丢包的问题，如果第四次挥手报文丢失，服务端会重新进行第三次挥手，这样来回发送报文的最长时间就是2msl，足够确保服务端可以接收到报文。



#### TCP可靠传输机制

##### tcp流量控制

流量控制是为了保证接收方能够接收到数据

##### tcp拥塞控制

拥塞控制是为了降低网络的拥塞情况
